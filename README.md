# Stationeers PyTrapIC - Transpiler from Python to IC10

## What is PyTrapIC

PyTrapIC is a Python tool to convert Python code into Stationeers IC10. See below for features and limitations.

Some code examples are [below](#examples).

## Simple Examples







<details open>
<summary><strong>Solar</strong> — <a href="https://aproposmath.github.io/stationeers-pytrapic?fileUrl=https://raw.githubusercontent.com/aproposmath/stationeers-pytrapic/refs/heads/main/src/stationeers_pytrapic/examples/solar.py" target="_blank" rel="noopener noreferrer">Try it</a></summary>

<table>
<th>Python</th>
<th>IC10</th>
<tr>
<td>

```py
from stationeers_pytrapic.symbols import *

panels = SolarPanels  # port facing north
sensor = DaylightSensor(d0)  # port facing east

while True:
    panels.Horizontal = sensor.Horizontal
    panels.Vertical = 90 - sensor.Vertical
```

</td>
<td>

```asm
lbwhile1: # Generated by PyTrapIC v0.2.3
  l r0 d0 Horizontal
  sb HASH("StructureSolarPanel") Horizontal r0
  l r0 d0 Vertical
  sub r1 90 r0
  sb HASH("StructureSolarPanel") Vertical r1
  j lbwhile1
```

</td>
</tr>
</table>
</details>

## How to use

- [Stationeers Mod](mod/README.md)

- [Online Editor](https://aproposmath.github.io/stationeers-pytrapic)

- Command line tool

```
pip install git+https://github.com/aproposmath/stationeers-pytrapic.git
python -m stationeers-pytrapic some_simple_code.py
```

## Implementation status

**Python Features**

- Common Python features: 
    - `+`, `-`, `*`, `/`, `%`, `+=`, `-=`, `*=`, `/=`, `and`, `or`, `not`
    - `if`, `else`, `while`, `for`, `break`, `continue`
    - `list` (only compile-time constant lists)
    - functions
    - `global`
- Type-safe access to structures (`WallHeater(d0).Activate = True`)
- Batch operations (use plural name) (`AutoLathes.Activate = True`)
- Named batch operations with `[]` operator (`my_value = WallLights["Some Name"].On.Maximum`)
- Slot access, either by name (`furnace.Export.Occupied`) or by index (`furnace.slot0.Occupied`)
- Auto-completion for logic types / slot types etc.
- Intrinsics (see below)
   all IC10 instructions can be called as functions, e.g. `a = pop()` or `x = lb(HASH("StructureWallHeater", "On", "Maximum")`)
- Optimizations (evaluate constant expressions, function inlining, remove unused code)
- `@constexpr` function decorator to force evaluation at compile time ([example below](#examples))
- Compile flags ([example below](#examples))

**Planned Features**

- Access slot by variable index (`furnace.slots[i].Occupied`)
- better register allocation (check scope in ic10 code instead of python code for more granularity)
- pass function arguments/return values in registers (currently only via stack)
- allow structures as function arguments/return values (currently only simple values like `float` are allowed)
- [you tell me!](https://github.com/aproposmath/stationeers-pytrapic/issues/new)

**NOT planned**

- lambda functions
- anything that is not supported by IC10 (e.g. classes, exceptions, etc.)
- anything provided by the Python standard library (e.g. `math`, `random`, etc.)
- list, dict, set, tuple, comprehensions (maybe later, but only for constant expressions)

## How does it work

The transpiler itself is written in Python and uses [astroid](https://pypi.org/project/astroid/) to parse python code.

The web application uses [Pyodide](https://pyodide.org/) to run the transpiler in the browser. The editor is based on [monaco](https://microsoft.github.io/monaco-editor/) and uses [monaco-pyright-lsp](https://github.com/SardineFish/monaco-pyright-lsp) for code completion. No data is sent to the server, everything is running in the browser.

## Examples




<details>
<summary><strong>Constexpr</strong> — <a href="https://aproposmath.github.io/stationeers-pytrapic?fileUrl=https://raw.githubusercontent.com/aproposmath/stationeers-pytrapic/refs/heads/main/src/stationeers_pytrapic/examples/constexpr.py" target="_blank" rel="noopener noreferrer">Try it</a></summary>

<table>
<th>Python</th>
<th>IC10</th>
<tr>
<td>

```py
from stationeers_pytrapic.symbols import *


@constexpr
def filter_by_sorting_class(cls, negate=False):
    condop = ConditionOperation.Equals
    if negate:
        condop = ConditionOperation.NotEquals
    condop = condop << 8
    cls = cls << 16
    return cls + condop + SorterInstruction.FilterSortingClassCompare


@constexpr
def filter_by_name(name, negate=False):
    hash = HASH(name) << 8
    instruction = SorterInstruction.FilterPrefabHashEquals
    if negate:
        instruction = SorterInstruction.FilterPrefabHashNotEquals
    return hash + instruction


# access the stack of a sorter
ores_sorter_stack = Stack(d0)
ores_sorter_stack[0] = filter_by_sorting_class(SortingClass.Ores)

no_ices_sorter_stack = Stack(d1)
no_ices_sorter_stack[0] = filter_by_sorting_class(SortingClass.Ices, negate=True)

# you can also get the stack by the reference id
only_steel = Stack(ref_id=0x3455)
only_steel[0] = filter_by_name("ItemSteelIngot")
```

</td>
<td>

```asm
put d0 0 $90003 # Generated by PyTrapIC v0.2.3
put d1 0 $A0303
putd $3455 0 -167626437375
```

</td>
</tr>
</table>
</details>

<details>
<summary><strong>Compiler Options</strong> — <a href="https://aproposmath.github.io/stationeers-pytrapic?fileUrl=https://raw.githubusercontent.com/aproposmath/stationeers-pytrapic/refs/heads/main/src/stationeers_pytrapic/examples/compiler_options.py" target="_blank" rel="noopener noreferrer">Try it</a></summary>

<table>
<th>Python</th>
<th>IC10</th>
<tr>
<td>

```py
from stationeers_pytrapic.symbols import *

# Available compiler options
# name              Default    Description
# compact           False      labels, evaluates hashes (if shorter), use numbers for logic types etc.,
#                              also implies remove-labels and inline-functions
# inline-functions  True       Inline function calls if possible
# remove-labels     False      removes jump labels
# append-version    True       add comment with PyTrapIC version

# Usage is demonstated below. Prepend "no-" for negating options.
# The options can appear anywhere in the code and will be applied globally.

# pytrapic: compact
# pytrapic: no-append-version
# pytrapic: no-inline-functions


def some_function():
    display = ConsoleLED1x2(d0)
    display.Mode = DisplayMode.String
    display.Setting = STR("Hi")


while True:
    some_function()
```

</td>
<td>

```asm
lbwhile1:
  jal some.function
  j lbwhile1
some.function:
  s d0 3 10
  s d0 12 26952
  j ra
```

</td>
</tr>
</table>
</details>
